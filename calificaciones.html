<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EstadÃ­sticas Â· CBTis 179</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:       #6b0f1a;
      --primary-light: #9e1f30;
      --accent:        #e63950;
      --green:         #00b894;
      --red:           #d63031;
      --blue:          #0984e3;
      --orange:        #e67e22;
      --purple:        #6c5ce7;
      --bg:            #f0f2f7;
      --surface:       #ffffff;
      --text:          #2d3436;
      --text-muted:    #636e72;
      --border:        #e0e3ea;
      --shadow:        0 4px 20px rgba(0,0,0,0.07);
      --shadow-lg:     0 8px 40px rgba(0,0,0,0.12);
      --radius:        14px;
      --radius-sm:     8px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ Login overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #3a0710 0%, #6b0f1a 50%, #9e1f30 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-card {
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 24px;
      padding: 3em 2.5em 2.5em;
      width: 100%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 24px 64px rgba(0,0,0,0.35);
    }

    .login-icon {
      width: 72px;
      height: 72px;
      background: rgba(255,255,255,0.15);
      border: 2px solid rgba(255,255,255,0.25);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.2em;
      font-size: 2em;
    }

    .login-card h2 {
      color: #fff;
      font-size: 1.25em;
      font-weight: 600;
      margin-bottom: 0.3em;
    }

    .login-card p {
      color: rgba(255,255,255,0.65);
      font-size: 0.85em;
      margin-bottom: 1.8em;
    }

    .login-card input {
      width: 100%;
      padding: 0.85em 1em;
      border: 1.5px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      margin-bottom: 0.8em;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }

    .login-card input::placeholder { color: rgba(255,255,255,0.45); }
    .login-card input:focus {
      border-color: rgba(255,255,255,0.55);
      background: rgba(255,255,255,0.14);
    }

    .login-card .btn-login {
      width: 100%;
      padding: 0.9em;
      background: #fff;
      color: var(--primary);
      border: none;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      margin-top: 0.4em;
      letter-spacing: 0.02em;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .login-card .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    #msg-login {
      color: #ffcdd2;
      font-size: 0.82em;
      margin-top: 0.9em;
      min-height: 1.1em;
    }

    /* â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .navbar {
      background: var(--primary);
      padding: 0.9em 2em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 16px rgba(0,0,0,0.22);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.9em;
    }

    .navbar-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25em;
      flex-shrink: 0;
    }

    .navbar-brand h1 {
      color: #fff;
      font-size: 1em;
      font-weight: 600;
      line-height: 1.2;
    }

    .navbar-brand span {
      color: rgba(255,255,255,0.58);
      font-size: 0.75em;
      font-weight: 400;
      display: block;
    }

    .navbar-badge {
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 20px;
      padding: 0.3em 1em;
      font-size: 0.75em;
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    /* â”€â”€ Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container {
      max-width: 1020px;
      margin: 0 auto;
      padding: 2em 1.5em 3em;
    }

    /* â”€â”€ Section title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      font-size: 0.82em;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin: 2.2em 0 0.9em;
      display: flex;
      align-items: center;
      gap: 0.6em;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* â”€â”€ Upload card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-panel {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.8em;
      box-shadow: var(--shadow);
    }

    .formato-info {
      background: #fffbea;
      border-left: 4px solid #f0ad00;
      border-radius: 0 8px 8px 0;
      padding: 0.9em 1.1em;
      font-size: 0.84em;
      margin: 0 0 1.2em;
      color: #5a4500;
    }

    .formato-info code {
      display: block;
      background: #fff8d6;
      padding: 0.6em 0.8em;
      border-radius: 6px;
      margin-top: 0.6em;
      font-family: monospace;
      white-space: pre;
      font-size: 0.92em;
    }

    .field-label {
      font-size: 0.82em;
      font-weight: 500;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.35em;
    }

    input[type="file"], select {
      width: 100%;
      padding: 0.65em 0.9em;
      border-radius: var(--radius-sm);
      border: 1.5px solid var(--border);
      font-family: 'Poppins', sans-serif;
      font-size: 0.87em;
      color: var(--text);
      background: var(--bg);
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="file"]:focus, select:focus { border-color: var(--primary); }

    .filtros {
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
      margin-top: 1.2em;
    }

    .filtros > div { flex: 1; min-width: 160px; }

    #error-msg {
      color: #c62828;
      background: #fce4ec;
      border: 1.5px solid #ef9a9a;
      padding: 0.7em 1em;
      border-radius: var(--radius-sm);
      margin-top: 0.7em;
      font-size: 0.84em;
      display: none;
    }

    /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(148px, 1fr));
      gap: 1em;
    }

    .stat-card {
      border-radius: var(--radius);
      padding: 1.4em 1.3em;
      text-align: center;
      position: relative;
      overflow: hidden;
      color: #fff;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      top: -28px;
      right: -28px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.10);
    }

    .stat-card.c-primary { background: linear-gradient(135deg, #6b0f1a, #9e1f30); }
    .stat-card.c-green   { background: linear-gradient(135deg, #00b894, #00cec9); }
    .stat-card.c-red     { background: linear-gradient(135deg, #d63031, #e17055); }
    .stat-card.c-blue    { background: linear-gradient(135deg, #0984e3, #74b9ff); }
    .stat-card.c-orange  { background: linear-gradient(135deg, #e67e22, #f0a500); }
    .stat-card.c-purple  { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }

    .stat-card .valor {
      font-size: 2.1em;
      font-weight: 700;
      line-height: 1;
      position: relative;
      z-index: 1;
    }

    .stat-card .etiqueta {
      font-size: 0.77em;
      margin-top: 0.4em;
      opacity: 0.88;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    /* â”€â”€ Charts grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .graficas {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2em;
    }

    .grafica-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5em;
      box-shadow: var(--shadow);
    }

    .grafica-box h3 {
      font-size: 0.78em;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 1em;
    }

    /* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrapper {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.87em;
    }

    thead th {
      background: var(--primary);
      color: #fff;
      padding: 0.8em 1em;
      text-align: left;
      font-weight: 500;
      font-size: 0.84em;
      white-space: nowrap;
    }

    tbody td {
      padding: 0.65em 1em;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:hover { background: #fce4ec; transition: background 0.15s; }

    td.reprobado { color: #d63031; font-weight: 600; }
    td.aprobado  { color: #00b894; font-weight: 600; }

    /* â”€â”€ Action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .acciones {
      display: flex;
      gap: 0.7em;
      flex-wrap: wrap;
      margin: 1.2em 0 0.8em;
    }

    .btn {
      padding: 0.65em 1.3em;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Poppins', sans-serif;
      font-size: 0.84em;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    }

    .btn:hover  { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.14); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-green   { background: var(--green);  color: #fff; }
    .btn-blue    { background: var(--blue);   color: #fff; }
    .btn-outline { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #resultados { animation: fadeUp 0.35s ease; }

    /* â”€â”€ Oculto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .oculto { display: none !important; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      text-align: center;
      padding: 1.5em;
      font-size: 0.76em;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      margin-top: 1em;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 620px) {
      .graficas { grid-template-columns: 1fr; }
      .cards    { grid-template-columns: repeat(2, 1fr); }
      .navbar   { padding: 0.9em 1.2em; }
      .navbar-badge { display: none; }
    }
  </style>
</head>
<body>

  <!-- â”€â”€ Login overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="login-overlay">
    <div class="login-card">
      <div class="login-icon">ðŸ“Š</div>
      <h2>EstadÃ­sticas Â· CBTis 179</h2>
      <p>Ingresa tus credenciales para continuar</p>
      <input type="text"     id="user" placeholder="Usuario"     autocomplete="off">
      <input type="password" id="pass" placeholder="ContraseÃ±a">
      <button class="btn-login" onclick="login()">Entrar al sistema</button>
      <div id="msg-login"></div>
    </div>
  </div>

  <!-- â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="app" class="oculto">

    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-brand">
        <div class="navbar-icon">ðŸ“Š</div>
        <div>
          <h1>EstadÃ­sticas de Calificaciones</h1>
          <span>CBTis No. 179</span>
        </div>
      </div>
      <div class="navbar-badge">Sistema escolar</div>
    </nav>

    <div class="container">

      <!-- Cargar archivo -->
      <p class="section-title">ðŸ“‚ Cargar archivo</p>
      <div class="card-panel">
        <div class="formato-info">
          <strong>Formato del archivo CSV:</strong> La primera fila debe contener los encabezados.
          La primera columna es el nombre del alumno; las siguientes columnas son las materias.
          Calificaciones de 0 a 10 â€” se considera <strong>aprobado â‰¥ 6</strong>.
          <code>Nombre,MatemÃ¡ticas,EspaÃ±ol,FÃ­sica,Historia
Juan PÃ©rez,8,7,9,6
MarÃ­a GarcÃ­a,5,8,7,9
Pedro LÃ³pez,6,6,5,7</code>
        </div>

        <label class="field-label">Archivo CSV de calificaciones</label>
        <input type="file" id="archivoCSV" accept=".csv">
        <div id="error-msg"></div>

        <div class="filtros" id="filtros-grupo" style="display:none;">
          <div>
            <label class="field-label">Filtrar por grupo</label>
            <select id="filtroGrupo" onchange="actualizarVista()">
              <option value="">Todos los alumnos</option>
            </select>
          </div>
          <div>
            <label class="field-label">Ordenar tabla por</label>
            <select id="ordenTabla" onchange="actualizarVista()">
              <option value="nombre">Nombre</option>
              <option value="promedio_desc">Promedio (mayor a menor)</option>
              <option value="promedio_asc">Promedio (menor a mayor)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div id="resultados" class="oculto">

        <p class="section-title">ðŸ“ˆ Resumen general</p>
        <div class="cards" id="cards-resumen"></div>

        <p class="section-title">ðŸ“‰ GrÃ¡ficas</p>
        <div class="graficas">
          <div class="grafica-box">
            <h3>DistribuciÃ³n de promedios</h3>
            <canvas id="graficaDistribucion"></canvas>
          </div>
          <div class="grafica-box">
            <h3>Aprobados vs Reprobados</h3>
            <canvas id="graficaAprobados"></canvas>
          </div>
          <div class="grafica-box">
            <h3>Promedio por materia</h3>
            <canvas id="graficaMaterias"></canvas>
          </div>
          <div class="grafica-box">
            <h3>Top 5 alumnos</h3>
            <canvas id="graficaTop5"></canvas>
          </div>
        </div>

        <p class="section-title">ðŸ“‹ EstadÃ­sticas por materia</p>
        <div class="table-wrapper" id="tabla-materias"></div>

        <p class="section-title">ðŸ‘¥ Calificaciones por alumno</p>
        <div class="acciones">
          <button class="btn btn-green"   onclick="exportarCSV()">â¬‡ Exportar CSV</button>
          <button class="btn btn-blue"    onclick="exportarResumenTexto()">ðŸ“„ Exportar TXT</button>
          <button class="btn btn-outline" onclick="imprimirPagina()">ðŸ–¨ Imprimir / PDF</button>
        </div>
        <div class="table-wrapper" id="tabla-alumnos"></div>

      </div><!-- /resultados -->

    </div><!-- /container -->

    <div class="footer">
      Â© 2025 â€” Desarrollado por <strong>Luis Eduardo Ibarra HernÃ¡ndez</strong> Â· CBTis No. 179
    </div>

  </div><!-- /app -->

  <script>
    // â”€â”€ Credenciales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const USER = "cbtis179";
    const PASS = "justificante2025";

    function login() {
      const u = document.getElementById("user").value;
      const p = document.getElementById("pass").value;
      if (u === USER && p === PASS) {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app").classList.remove("oculto");
      } else {
        document.getElementById("msg-login").textContent = "Usuario o contraseÃ±a incorrectos.";
      }
    }

    document.addEventListener("keydown", e => {
      if (e.key === "Enter" && document.getElementById("login-overlay").style.display !== "none") login();
    });

    // â”€â”€ Estado global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let datosOriginales = [];
    let materias        = [];
    let graficas        = {};

    // â”€â”€ Carga de archivo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("archivoCSV").addEventListener("change", function(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try { procesarCSV(ev.target.result); }
        catch(err) { mostrarError("Error al leer el archivo: " + err.message); }
      };
      reader.readAsText(archivo, "UTF-8");
    });

    function mostrarError(msg) {
      const el = document.getElementById("error-msg");
      el.textContent = msg;
      el.style.display = "block";
      document.getElementById("resultados").classList.add("oculto");
    }

    function ocultarError() {
      document.getElementById("error-msg").style.display = "none";
    }

    // â”€â”€ Parseo CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parsearCSV(texto) {
      const lineas = texto.trim().split(/\r?\n/);
      return lineas.map(linea => {
        const cols = [];
        let dentro = false, campo = "";
        for (let c of linea) {
          if (c === '"') { dentro = !dentro; }
          else if (c === ',' && !dentro) { cols.push(campo.trim()); campo = ""; }
          else { campo += c; }
        }
        cols.push(campo.trim());
        return cols;
      });
    }

    function procesarCSV(texto) {
      ocultarError();
      const filas = parsearCSV(texto);
      if (filas.length < 2) { mostrarError("El archivo debe tener al menos una fila de encabezado y un alumno."); return; }

      const encabezados = filas[0];
      if (encabezados.length < 2) { mostrarError("Se necesita al menos una columna de nombre y una materia."); return; }

      let colInicio = 1;
      let tieneGrupo = false;
      const primeraFila = filas[1];
      if (encabezados.length >= 3 && isNaN(parseFloat(primeraFila[1]))) {
        tieneGrupo = true;
        colInicio = 2;
      }

      materias = encabezados.slice(colInicio);
      if (materias.length === 0) { mostrarError("No se encontraron columnas de materias."); return; }

      datosOriginales = [];
      const grupos = new Set();

      for (let i = 1; i < filas.length; i++) {
        const fila = filas[i];
        if (fila.every(c => c === "")) continue;

        const nombre = fila[0] || `Alumno ${i}`;
        const grupo  = tieneGrupo ? (fila[1] || "") : "";
        if (grupo) grupos.add(grupo);

        const califs = {};
        let suma = 0, conteo = 0;
        for (let j = 0; j < materias.length; j++) {
          const val = parseFloat(fila[colInicio + j]);
          if (!isNaN(val)) {
            califs[materias[j]] = Math.min(10, Math.max(0, val));
            suma += califs[materias[j]];
            conteo++;
          } else {
            califs[materias[j]] = null;
          }
        }
        const promedio = conteo > 0 ? suma / conteo : 0;
        datosOriginales.push({ nombre, grupo, materias: califs, promedio });
      }

      if (datosOriginales.length === 0) { mostrarError("No se encontraron alumnos en el archivo."); return; }

      const selectGrupo = document.getElementById("filtroGrupo");
      selectGrupo.innerHTML = '<option value="">Todos los alumnos</option>';
      grupos.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g; opt.textContent = g;
        selectGrupo.appendChild(opt);
      });
      document.getElementById("filtros-grupo").style.display = tieneGrupo ? "flex" : "none";

      actualizarVista();
      document.getElementById("resultados").classList.remove("oculto");
    }

    // â”€â”€ Vista principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function actualizarVista() {
      const grupoFiltro = document.getElementById("filtroGrupo").value;
      const orden       = document.getElementById("ordenTabla").value;

      let datos = grupoFiltro
        ? datosOriginales.filter(a => a.grupo === grupoFiltro)
        : [...datosOriginales];

      if (orden === "promedio_desc") datos.sort((a,b) => b.promedio - a.promedio);
      else if (orden === "promedio_asc") datos.sort((a,b) => a.promedio - b.promedio);
      else datos.sort((a,b) => a.nombre.localeCompare(b.nombre));

      renderCards(datos);
      renderGraficas(datos);
      renderTablaMaterias(datos);
      renderTablaAlumnos(datos);
    }

    // â”€â”€ Tarjetas de resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCards(datos) {
      const total       = datos.length;
      const aprobados   = datos.filter(a => a.promedio >= 6).length;
      const reprobados  = total - aprobados;
      const promedioGen = total > 0 ? datos.reduce((s,a) => s+a.promedio, 0) / total : 0;
      const maxProm     = total > 0 ? Math.max(...datos.map(a => a.promedio)) : 0;
      const minProm     = total > 0 ? Math.min(...datos.map(a => a.promedio)) : 0;

      document.getElementById("cards-resumen").innerHTML = `
        <div class="stat-card c-blue">
          <div class="valor">${total}</div>
          <div class="etiqueta">Alumnos</div>
        </div>
        <div class="stat-card c-primary">
          <div class="valor">${promedioGen.toFixed(2)}</div>
          <div class="etiqueta">Promedio general</div>
        </div>
        <div class="stat-card c-green">
          <div class="valor">${aprobados}</div>
          <div class="etiqueta">Aprobados (${total > 0 ? (aprobados/total*100).toFixed(1) : 0}%)</div>
        </div>
        <div class="stat-card c-red">
          <div class="valor">${reprobados}</div>
          <div class="etiqueta">Reprobados (${total > 0 ? (reprobados/total*100).toFixed(1) : 0}%)</div>
        </div>
        <div class="stat-card c-orange">
          <div class="valor">${maxProm.toFixed(2)}</div>
          <div class="etiqueta">Promedio mÃ¡s alto</div>
        </div>
        <div class="stat-card c-purple">
          <div class="valor">${minProm.toFixed(2)}</div>
          <div class="etiqueta">Promedio mÃ¡s bajo</div>
        </div>
      `;
    }

    // â”€â”€ GrÃ¡ficas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function destruirGrafica(id) {
      if (graficas[id]) { graficas[id].destroy(); delete graficas[id]; }
    }

    function renderGraficas(datos) {
      destruirGrafica("dist");
      const rangos = { "0â€“4.9": 0, "5": 0, "6â€“6.9": 0, "7â€“7.9": 0, "8â€“8.9": 0, "9â€“10": 0 };
      datos.forEach(a => {
        const p = a.promedio;
        if      (p < 5) rangos["0â€“4.9"]++;
        else if (p < 6) rangos["5"]++;
        else if (p < 7) rangos["6â€“6.9"]++;
        else if (p < 8) rangos["7â€“7.9"]++;
        else if (p < 9) rangos["8â€“8.9"]++;
        else            rangos["9â€“10"]++;
      });
      graficas["dist"] = new Chart(document.getElementById("graficaDistribucion"), {
        type: "bar",
        data: {
          labels: Object.keys(rangos),
          datasets: [{
            label: "Alumnos",
            data: Object.values(rangos),
            backgroundColor: ["#d63031","#e17055","#fdcb6e","#00b894","#0984e3","#6c5ce7"],
            borderRadius: 6
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      destruirGrafica("apro");
      const aprobados  = datos.filter(a => a.promedio >= 6).length;
      const reprobados = datos.length - aprobados;
      graficas["apro"] = new Chart(document.getElementById("graficaAprobados"), {
        type: "doughnut",
        data: {
          labels: ["Aprobados", "Reprobados"],
          datasets: [{ data: [aprobados, reprobados], backgroundColor: ["#00b894","#d63031"], borderWidth: 0 }]
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } }, cutout: "65%" }
      });

      destruirGrafica("mat");
      const promediosMat = materias.map(mat => {
        const vals = datos.map(a => a.materias[mat]).filter(v => v !== null && v !== undefined);
        return vals.length > 0 ? vals.reduce((s,v) => s+v, 0) / vals.length : 0;
      });
      graficas["mat"] = new Chart(document.getElementById("graficaMaterias"), {
        type: "bar",
        data: {
          labels: materias,
          datasets: [{
            label: "Promedio",
            data: promediosMat.map(v => parseFloat(v.toFixed(2))),
            backgroundColor: "#6b0f1a",
            borderRadius: 6
          }]
        },
        options: { responsive: true, scales: { y: { min: 0, max: 10 } }, plugins: { legend: { display: false } } }
      });

      destruirGrafica("top5");
      const top5 = [...datos].sort((a,b) => b.promedio - a.promedio).slice(0, 5);
      graficas["top5"] = new Chart(document.getElementById("graficaTop5"), {
        type: "bar",
        data: {
          labels: top5.map(a => a.nombre.split(" ")[0]),
          datasets: [{
            label: "Promedio",
            data: top5.map(a => parseFloat(a.promedio.toFixed(2))),
            backgroundColor: ["#0984e3","#6c5ce7","#00b894","#e67e22","#d63031"],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: { y: { min: 0, max: 10 } },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { title: (items) => top5[items[0].dataIndex].nombre } }
          }
        }
      });
    }

    // â”€â”€ Tabla por materia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTablaMaterias(datos) {
      let html = "<table><thead><tr><th>Materia</th><th>Promedio</th><th>MÃ¡ximo</th><th>MÃ­nimo</th><th>Aprobados</th><th>Reprobados</th></tr></thead><tbody>";
      materias.forEach(mat => {
        const vals = datos.map(a => a.materias[mat]).filter(v => v !== null && v !== undefined);
        if (vals.length === 0) return;
        const prom = vals.reduce((s,v) => s+v, 0) / vals.length;
        const max  = Math.max(...vals);
        const min  = Math.min(...vals);
        const apro = vals.filter(v => v >= 6).length;
        const repr = vals.length - apro;
        html += `<tr>
          <td>${mat}</td><td>${prom.toFixed(2)}</td><td>${max}</td><td>${min}</td>
          <td class="aprobado">${apro}</td><td class="reprobado">${repr}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("tabla-materias").innerHTML = html;
    }

    // â”€â”€ Tabla por alumno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTablaAlumnos(datos) {
      let html = "<table><thead><tr><th>#</th><th>Nombre</th>";
      if (datos.some(a => a.grupo)) html += "<th>Grupo</th>";
      materias.forEach(m => html += `<th>${m}</th>`);
      html += "<th>Promedio</th><th>Estado</th></tr></thead><tbody>";

      datos.forEach((a, i) => {
        const aprobado = a.promedio >= 6;
        html += `<tr>
          <td>${i+1}</td><td>${a.nombre}</td>
          ${datos.some(x => x.grupo) ? `<td>${a.grupo}</td>` : ""}
          ${materias.map(m => {
            const v = a.materias[m];
            if (v === null || v === undefined) return "<td>â€”</td>";
            return `<td class="${v < 6 ? 'reprobado' : ''}">${v}</td>`;
          }).join("")}
          <td><strong>${a.promedio.toFixed(2)}</strong></td>
          <td class="${aprobado ? 'aprobado' : 'reprobado'}">${aprobado ? "âœ“ Aprobado" : "âœ— Reprobado"}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("tabla-alumnos").innerHTML = html;
    }

    // â”€â”€ Exportar CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function exportarCSV() {
      const grupoFiltro = document.getElementById("filtroGrupo").value;
      let datos = grupoFiltro
        ? datosOriginales.filter(a => a.grupo === grupoFiltro)
        : [...datosOriginales];

      let csv = ["Nombre", ...(datos.some(a=>a.grupo) ? ["Grupo"] : []), ...materias, "Promedio", "Estado"].join(",") + "\n";
      datos.forEach(a => {
        const fila = [
          `"${a.nombre}"`,
          ...(datos.some(x=>x.grupo) ? [`"${a.grupo}"`] : []),
          ...materias.map(m => a.materias[m] ?? ""),
          a.promedio.toFixed(2),
          a.promedio >= 6 ? "Aprobado" : "Reprobado"
        ];
        csv += fila.join(",") + "\n";
      });
      descargar("estadisticas_calificaciones.csv", csv, "text/csv");
    }

    // â”€â”€ Exportar resumen TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function exportarResumenTexto() {
      const total      = datosOriginales.length;
      const aprobados  = datosOriginales.filter(a => a.promedio >= 6).length;
      const reprobados = total - aprobados;
      const promGen    = total > 0 ? datosOriginales.reduce((s,a) => s+a.promedio, 0) / total : 0;

      let txt = `REPORTE DE ESTADÃSTICAS DE CALIFICACIONES\nCBTis No. 179\n`;
      txt    += `Fecha: ${new Date().toLocaleDateString("es-MX", {year:"numeric",month:"long",day:"numeric"})}\n\n`;
      txt    += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nRESUMEN GENERAL\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
      txt    += `Total de alumnos : ${total}\nPromedio general : ${promGen.toFixed(2)}\n`;
      txt    += `Aprobados        : ${aprobados} (${(aprobados/total*100).toFixed(1)}%)\n`;
      txt    += `Reprobados       : ${reprobados} (${(reprobados/total*100).toFixed(1)}%)\n\n`;
      txt    += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nESTADÃSTICAS POR MATERIA\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
      materias.forEach(mat => {
        const vals = datosOriginales.map(a => a.materias[mat]).filter(v => v !== null && v !== undefined);
        if (vals.length === 0) return;
        const prom = vals.reduce((s,v) => s+v, 0) / vals.length;
        txt += `${mat.padEnd(25)} Promedio: ${prom.toFixed(2)}\n`;
      });
      descargar("resumen_calificaciones.txt", txt, "text/plain");
    }

    function descargar(nombre, contenido, tipo) {
      const blob = new Blob([contenido], { type: tipo });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = nombre;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function imprimirPagina() { window.print(); }
  </script>
</body>
</html>
